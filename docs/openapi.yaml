openapi: '3.1.0'
info:
  title: StatusGuard API
  description: |
    REST API for StatusGuard — a self-hosted, multi-tenant status page platform.
    All endpoints return JSON. Admin endpoints require OIDC Bearer token.
  version: '1.0.0'
  contact:
    name: StatusGuard
servers:
  - url: /api/v1
    description: Default (relative)

security: []

paths:
  # ─── Status Pages ───────────────────────────────────────
  /status-pages:
    get:
      summary: List status pages
      tags: [Status Pages]
      parameters:
        - $ref: '#/components/parameters/Page'
        - $ref: '#/components/parameters/PageSize'
      responses:
        '200':
          description: Paginated list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedStatusPages'
    post:
      summary: Create status page
      tags: [Status Pages]
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateStatusPageRequest'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusPage'

  /status-pages/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema: { type: string, format: uuid }
    get:
      summary: Get status page by ID (with services and incidents)
      tags: [Status Pages]
      responses:
        '200':
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusPageDetail'
    put:
      summary: Update status page
      tags: [Status Pages]
      security: [{ bearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateStatusPageRequest'
      responses:
        '200':
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusPage'
    delete:
      summary: Delete status page
      tags: [Status Pages]
      security: [{ bearerAuth: [] }]
      responses:
        '204':
          description: Deleted

  /status-pages/by-slug/{slug}:
    parameters:
      - name: slug
        in: path
        required: true
        schema: { type: string }
    get:
      summary: Get status page by slug (public)
      tags: [Status Pages]
      responses:
        '200':
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusPageDetail'

  # ─── Services ───────────────────────────────────────────
  /services:
    get:
      summary: List services
      tags: [Services]
      parameters:
        - name: statusPageId
          in: query
          schema: { type: string, format: uuid }
        - $ref: '#/components/parameters/Page'
        - $ref: '#/components/parameters/PageSize'
      responses:
        '200':
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedServices'
    post:
      summary: Create service
      tags: [Services]
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateServiceRequest'
      responses:
        '201':
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Service'

  /services/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema: { type: string, format: uuid }
    patch:
      summary: Update service
      tags: [Services]
      security: [{ bearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateServiceRequest'
      responses:
        '200':
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Service'
    delete:
      summary: Delete service
      tags: [Services]
      security: [{ bearerAuth: [] }]
      responses:
        '204':
          description: Deleted

  # ─── Metrics ────────────────────────────────────────────
  /metrics/{serviceId}:
    parameters:
      - name: serviceId
        in: path
        required: true
        schema: { type: string, format: uuid }
    get:
      summary: Get service metrics (histogram-based)
      tags: [Metrics]
      parameters:
        - name: range
          in: query
          schema:
            type: string
            enum: ['1h', '6h', '24h', '7d', '30d']
            default: '24h'
        - name: resolution
          in: query
          schema:
            type: string
            enum: ['1m', '5m', '1h']
            default: '1m'
      responses:
        '200':
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MetricsResponse'

  # ─── Incidents ──────────────────────────────────────────
  /incidents:
    get:
      summary: List incidents
      tags: [Incidents]
      parameters:
        - name: statusPageId
          in: query
          schema: { type: string, format: uuid }
        - name: status
          in: query
          schema: { type: string }
        - $ref: '#/components/parameters/Page'
        - $ref: '#/components/parameters/PageSize'
      responses:
        '200':
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedIncidents'
    post:
      summary: Create incident
      tags: [Incidents]
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateIncidentRequest'
      responses:
        '201':
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Incident'

  /incidents/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema: { type: string, format: uuid }
    get:
      summary: Get incident with timeline updates
      tags: [Incidents]
      responses:
        '200':
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IncidentDetail'
    patch:
      summary: Update incident
      tags: [Incidents]
      security: [{ bearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateIncidentRequest'
      responses:
        '200':
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Incident'
    delete:
      summary: Delete incident
      tags: [Incidents]
      security: [{ bearerAuth: [] }]
      responses:
        '204':
          description: Deleted

  /incidents/{id}/updates:
    parameters:
      - name: id
        in: path
        required: true
        schema: { type: string, format: uuid }
    post:
      summary: Add incident timeline update
      tags: [Incidents]
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateIncidentUpdateRequest'
      responses:
        '201':
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IncidentUpdate'

  # ─── Broadcasts ─────────────────────────────────────────
  /broadcasts:
    post:
      summary: Create broadcast message
      tags: [Broadcasts]
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateBroadcastRequest'
      responses:
        '201':
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BroadcastMessage'

  /broadcasts/active:
    get:
      summary: Get active broadcast for a status page
      tags: [Broadcasts]
      parameters:
        - name: statusPageId
          in: query
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200':
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BroadcastMessage'

  /broadcasts/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema: { type: string, format: uuid }
    delete:
      summary: Delete/expire broadcast
      tags: [Broadcasts]
      security: [{ bearerAuth: [] }]
      responses:
        '204':
          description: Deleted

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: OIDC access token

  parameters:
    Page:
      name: page
      in: query
      schema: { type: integer, default: 1, minimum: 1 }
    PageSize:
      name: pageSize
      in: query
      schema: { type: integer, default: 20, minimum: 1, maximum: 100 }

  schemas:
    # ── Pagination ──
    PaginatedStatusPages:
      type: object
      properties:
        data: { type: array, items: { $ref: '#/components/schemas/StatusPage' } }
        total: { type: integer }
        page: { type: integer }
        pageSize: { type: integer }
        totalPages: { type: integer }

    PaginatedServices:
      type: object
      properties:
        data: { type: array, items: { $ref: '#/components/schemas/Service' } }
        total: { type: integer }
        page: { type: integer }
        pageSize: { type: integer }
        totalPages: { type: integer }

    PaginatedIncidents:
      type: object
      properties:
        data: { type: array, items: { $ref: '#/components/schemas/Incident' } }
        total: { type: integer }
        page: { type: integer }
        pageSize: { type: integer }
        totalPages: { type: integer }

    # ── Status Page ──
    StatusPage:
      type: object
      required: [id, name, slug, description, globalStatus, createdAt, updatedAt]
      properties:
        id: { type: string, format: uuid }
        name: { type: string }
        slug: { type: string }
        description: { type: string }
        logoUrl: { type: string, nullable: true }
        brandColor: { type: string, nullable: true }
        customCss: { type: string, nullable: true }
        globalStatus: { $ref: '#/components/schemas/ServiceStatus' }
        broadcastMessage: { type: string, nullable: true }
        broadcastExpiresAt: { type: string, format: date-time, nullable: true }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }

    StatusPageDetail:
      allOf:
        - $ref: '#/components/schemas/StatusPage'
        - type: object
          properties:
            services: { type: array, items: { $ref: '#/components/schemas/Service' } }
            activeIncidents: { type: array, items: { $ref: '#/components/schemas/Incident' } }

    CreateStatusPageRequest:
      type: object
      required: [name, slug, description]
      properties:
        name: { type: string, maxLength: 100 }
        slug: { type: string, pattern: '^[a-z0-9-]+$', maxLength: 50 }
        description: { type: string, maxLength: 500 }
        logoUrl: { type: string }
        brandColor: { type: string }
        customCss: { type: string }

    UpdateStatusPageRequest:
      type: object
      properties:
        name: { type: string }
        slug: { type: string }
        description: { type: string }
        logoUrl: { type: string }
        brandColor: { type: string }
        customCss: { type: string }

    # ── Service ──
    Service:
      type: object
      required: [id, statusPageId, name, endpoint, protocol, checkIntervalSeconds, timeoutMs, expectedStatusCode, status, availability, avgLatency, p95Latency, p99Latency, createdAt, updatedAt]
      properties:
        id: { type: string, format: uuid }
        statusPageId: { type: string, format: uuid }
        name: { type: string }
        endpoint: { type: string }
        protocol: { type: string, enum: [HTTP, HTTPS, TCP, gRPC] }
        checkIntervalSeconds: { type: integer, minimum: 60 }
        timeoutMs: { type: integer }
        expectedStatusCode: { type: integer }
        status: { $ref: '#/components/schemas/ServiceStatus' }
        availability: { type: number, format: float }
        avgLatency: { type: number, format: float }
        p95Latency: { type: number, format: float }
        p99Latency: { type: number, format: float }
        lastCheckedAt: { type: string, format: date-time, nullable: true }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }

    CreateServiceRequest:
      type: object
      required: [statusPageId, name, endpoint, protocol, checkIntervalSeconds, timeoutMs, expectedStatusCode]
      properties:
        statusPageId: { type: string, format: uuid }
        name: { type: string }
        endpoint: { type: string }
        protocol: { type: string, enum: [HTTP, HTTPS, TCP, gRPC] }
        checkIntervalSeconds: { type: integer, minimum: 60 }
        timeoutMs: { type: integer, minimum: 1000 }
        expectedStatusCode: { type: integer }

    UpdateServiceRequest:
      type: object
      properties:
        name: { type: string }
        endpoint: { type: string }
        protocol: { type: string, enum: [HTTP, HTTPS, TCP, gRPC] }
        checkIntervalSeconds: { type: integer, minimum: 60 }
        timeoutMs: { type: integer }
        expectedStatusCode: { type: integer }

    ServiceStatus:
      type: string
      enum: [operational, degraded, down, maintenance]

    # ── Metrics ──
    MetricsResponse:
      type: object
      required: [serviceId, range, resolution, points]
      properties:
        serviceId: { type: string, format: uuid }
        range: { type: string, enum: ['1h', '6h', '24h', '7d', '30d'] }
        resolution: { type: string, enum: ['1m', '5m', '1h'] }
        points:
          type: array
          items: { $ref: '#/components/schemas/MetricPoint' }
          description: |
            Array of metric points at the requested resolution.
            For 24h at 1m resolution, expect 1440 points.
            Points with isGap=true indicate missing data.

    MetricPoint:
      type: object
      required: [timestamp, latencyAvg, latencyP95, latencyP99, availability]
      properties:
        timestamp: { type: string, format: date-time }
        latencyAvg: { type: number, format: float, description: 'Average latency in ms (histogram-computed)' }
        latencyP95: { type: number, format: float, description: '95th percentile latency in ms' }
        latencyP99: { type: number, format: float, description: '99th percentile latency in ms' }
        availability: { type: number, format: float, description: 'Availability percentage for this interval' }
        isGap: { type: boolean, description: 'True if no data was collected for this interval' }

    # ── Incidents ──
    Incident:
      type: object
      required: [id, statusPageId, title, status, severity, affectedServiceIds, createdAt, updatedAt]
      properties:
        id: { type: string, format: uuid }
        statusPageId: { type: string, format: uuid }
        title: { type: string }
        status: { type: string, enum: [investigating, identified, monitoring, resolved] }
        severity: { type: string, enum: [minor, major, critical] }
        affectedServiceIds: { type: array, items: { type: string, format: uuid } }
        createdAt: { type: string, format: date-time }
        resolvedAt: { type: string, format: date-time, nullable: true }
        updatedAt: { type: string, format: date-time }

    IncidentDetail:
      allOf:
        - $ref: '#/components/schemas/Incident'
        - type: object
          properties:
            updates: { type: array, items: { $ref: '#/components/schemas/IncidentUpdate' } }

    IncidentUpdate:
      type: object
      required: [id, incidentId, status, message, createdAt]
      properties:
        id: { type: string, format: uuid }
        incidentId: { type: string, format: uuid }
        status: { type: string, enum: [investigating, identified, monitoring, resolved] }
        message: { type: string }
        createdAt: { type: string, format: date-time }

    CreateIncidentRequest:
      type: object
      required: [statusPageId, title, severity, affectedServiceIds, message]
      properties:
        statusPageId: { type: string, format: uuid }
        title: { type: string }
        severity: { type: string, enum: [minor, major, critical] }
        affectedServiceIds: { type: array, items: { type: string, format: uuid } }
        message: { type: string }

    UpdateIncidentRequest:
      type: object
      properties:
        status: { type: string, enum: [investigating, identified, monitoring, resolved] }
        title: { type: string }
        severity: { type: string, enum: [minor, major, critical] }
        affectedServiceIds: { type: array, items: { type: string, format: uuid } }

    CreateIncidentUpdateRequest:
      type: object
      required: [status, message]
      properties:
        status: { type: string, enum: [investigating, identified, monitoring, resolved] }
        message: { type: string }

    # ── Broadcasts ──
    BroadcastMessage:
      type: object
      required: [id, statusPageId, message, createdAt]
      properties:
        id: { type: string, format: uuid }
        statusPageId: { type: string, format: uuid }
        message: { type: string }
        expiresAt: { type: string, format: date-time, nullable: true }
        createdAt: { type: string, format: date-time }

    CreateBroadcastRequest:
      type: object
      required: [statusPageId, message]
      properties:
        statusPageId: { type: string, format: uuid }
        message: { type: string }
        expiresAt: { type: string, format: date-time }
